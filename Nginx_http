#!/bin/bash

# ============================
# Variables
# ============================
DOMAIN="websites.com"                # Replace with your domain or keep localhost
WEB_ROOT="/var/www/$DOMAIN/public_html"
BACKEND_URL="http://127.0.0.1:5000"  # Backend URL (Flask/Node app on port 5000)

# ============================
# Install Dependencies
# ============================
echo "üîß Installing required packages..."
sudo apt update -y
sudo apt install -y nginx python3 nodejs npm

# ============================
# Stop Apache if running (avoid conflict)
# ============================
if systemctl is-active --quiet apache2; then
    echo "‚ö†Ô∏è Stopping Apache server to free port 80..."
    sudo systemctl stop apache2
    sudo systemctl disable apache2
fi

# ============================
# Create website directory
# ============================
echo "üìÅ Creating website directory at $WEB_ROOT..."
sudo mkdir -p $WEB_ROOT
sudo chown -R $USER:$USER /var/www/$DOMAIN
sudo chmod -R 755 /var/www/

# ============================
# Create simple HTML homepage
# ============================
echo "üìù Creating default index.html page..."
cat <<EOF > $WEB_ROOT/index.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Welcome to $DOMAIN</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f3f4f6;
            color: #333;
            text-align: center;
            padding: 50px;
        }
        h1 { color: #2c3e50; }
        p { font-size: 1.2em; }
    </style>
</head>
<body>
    <h1>Hello from $DOMAIN!</h1>
    <p>This is brundha.</p>
</body>
</html>
EOF

# ============================
# Create NGINX configuration
# ============================
echo "‚öôÔ∏è Setting up NGINX configuration..."
NGINX_CONF="/etc/nginx/sites-available/$DOMAIN"
sudo bash -c "cat > $NGINX_CONF" <<EOL
server {
    listen 80;
    server_name $DOMAIN www.$DOMAIN;

    root $WEB_ROOT;
    index index.html;

    # Serve static files
    location / {
        try_files \$uri \$uri/ =404;
    }

    # Reverse proxy to backend
    location /api/ {
        proxy_pass $BACKEND_URL/;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOL

# ============================
# Enable NGINX site
# ============================
sudo ln -sf $NGINX_CONF /etc/nginx/sites-enabled/

# ============================
# Start Backend (Flask or Node.js)
# ============================
echo "üöÄ Checking for backend..."
if [ -f "app.py" ]; then
    echo "üì¶ Flask backend detected. Starting Flask on port 5000..."
    nohup python3 app.py > flask.log 2>&1 &
else
    echo "‚ö†Ô∏è No backend found (app.py or server.js missing)."
fi

# ============================
# Test and reload NGINX
# ============================
echo "üîç Testing NGINX configuration..."
if sudo nginx -t; then
    echo "üîÑ Reloading NGINX..."
    sudo systemctl reload nginx
    sudo systemctl enable nginx
    echo "‚úÖ Website hosted successfully at http://$DOMAIN"
    echo "‚ÑπÔ∏è  Make sure DNS for $DOMAIN points to this server‚Äôs IP or use http://localhost"
else
    echo "‚ùå NGINX configuration test failed. Please check errors above."
fi
